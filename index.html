<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Capybara Command Center</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { background:#0a0814; color:#e8dcc8; font-family:'Noto Sans JP',sans-serif; min-height:100vh; }
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-track { background:rgba(0,0,0,0.2); }
::-webkit-scrollbar-thumb { background:rgba(240,192,64,0.3); border-radius:999px; }
@keyframes fadeIn { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
@keyframes popIn  { from{opacity:0;transform:scale(0.4)} to{opacity:1;transform:scale(1)} }
@keyframes shimmer { 0%{background-position:200% center} 100%{background-position:-200% center} }
@keyframes floatUp { 0%{opacity:0;transform:translateY(0)} 60%{opacity:1} 100%{opacity:0;transform:translateY(-40px)} }
@keyframes ssrPulse { 0%,100%{box-shadow:0 0 12px rgba(240,192,64,0.5),0 0 40px rgba(240,192,64,0.2)} 50%{box-shadow:0 0 24px rgba(240,192,64,0.9),0 0 70px rgba(240,192,64,0.4)} }
/* Gacha new animations */
@keyframes chestShake { 0%,100%{transform:rotate(0deg)} 20%{transform:rotate(-8deg)} 40%{transform:rotate(8deg)} 60%{transform:rotate(-5deg)} 80%{transform:rotate(5deg)} }
@keyframes chestOpen  { 0%{transform:scaleY(1) translateY(0)} 50%{transform:scaleY(0.1) translateY(10px)} 100%{transform:scaleY(0) translateY(20px) opacity(0)} }
@keyframes cardFlip   { 0%{transform:rotateY(90deg) scale(0.8);opacity:0} 100%{transform:rotateY(0deg) scale(1);opacity:1} }
@keyframes ssrFlash   { 0%{opacity:0} 15%{opacity:1} 85%{opacity:1} 100%{opacity:0} }
@keyframes ssrShake   { 0%,100%{transform:translate(0,0)} 10%{transform:translate(-4px,2px)} 20%{transform:translate(4px,-2px)} 30%{transform:translate(-3px,3px)} 40%{transform:translate(3px,-1px)} 50%{transform:translate(-2px,2px)} 60%{transform:translate(2px,-2px)} 70%{transform:translate(-3px,1px)} 80%{transform:translate(3px,2px)} 90%{transform:translate(-1px,-2px)} }
@keyframes confettiFall { 0%{transform:translateY(-10px) rotate(0deg);opacity:1} 100%{transform:translateY(100vh) rotate(720deg);opacity:0} }
@keyframes sparkle    { 0%,100%{opacity:0;transform:scale(0)} 50%{opacity:1;transform:scale(1)} }
@keyframes glowPulse  { 0%,100%{text-shadow:0 0 10px currentColor} 50%{text-shadow:0 0 30px currentColor, 0 0 60px currentColor} }
</style>
</head>
<body>
<div id="root"></div>
<script>
const { useState, useEffect, useRef, useCallback } = React;
const h = React.createElement;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  CONSTANTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const RANK_DATA = {
  slime:  { label:"ã‚¹ãƒ©ã‚¤ãƒ ", emoji:"ðŸŸ¢", xp:10,  gold:5,  hpCost:2,  mpCost:1  },
  goblin: { label:"ã‚´ãƒ–ãƒªãƒ³", emoji:"ðŸŸ¡", xp:25,  gold:12, hpCost:5,  mpCost:3  },
  dragon: { label:"ãƒ‰ãƒ©ã‚´ãƒ³", emoji:"ðŸŸ ", xp:60,  gold:30, hpCost:15, mpCost:8  },
  maou:   { label:"é­”çŽ‹",     emoji:"ðŸŸ£", xp:150, gold:80, hpCost:35, mpCost:20 },
};

const XP_NEEDED = lv => Math.floor(100 * Math.pow(1.4, lv - 1));
const MAX_HP    = lv => 100 + (lv - 1) * 20;
const MAX_MP    = lv => 50  + (lv - 1) * 10;

// â”€â”€ Rarity â”€â”€
const RC = {
  N:   { color:"#9ca3af", glow:"rgba(156,163,175,0.4)", bg:"rgba(156,163,175,0.08)", border:"rgba(156,163,175,0.25)" },
  R:   { color:"#60a5fa", glow:"rgba(96,165,250,0.5)",  bg:"rgba(96,165,250,0.12)",  border:"rgba(96,165,250,0.35)"  },
  SR:  { color:"#a855f7", glow:"rgba(168,85,247,0.6)",  bg:"rgba(168,85,247,0.15)",  border:"rgba(168,85,247,0.45)"  },
  SSR: { color:"#f0c040", glow:"rgba(240,192,64,0.8)",  bg:"rgba(240,192,64,0.18)",  border:"rgba(240,192,64,0.6)"   },
};

// â”€â”€ Equipment pool (weapons & armor â†’ stats) â”€â”€
const EQUIP_POOL = [
  // N
  { id:"sw_n",  name:"é‰„ã®å‰£",    icon:"âš”ï¸", rarity:"N",   slot:"weapon", atk:3,  def:0  },
  { id:"sh_n",  name:"æœ¨ã®ç›¾",    icon:"ðŸ›¡ï¸", rarity:"N",   slot:"armor",  atk:0,  def:3  },
  { id:"rn_n",  name:"éŠ…ã®æŒ‡è¼ª",  icon:"ðŸ’", rarity:"N",   slot:"acc",    atk:1,  def:1  },
  // R
  { id:"sw_r",  name:"éŠ€ã®å‰£",    icon:"ðŸ—¡ï¸", rarity:"R",   slot:"weapon", atk:8,  def:0  },
  { id:"sh_r",  name:"é‰„ã®ç›¾",    icon:"ðŸ”°", rarity:"R",   slot:"armor",  atk:0,  def:8  },
  { id:"st_r",  name:"é­”æ³•ã®æ–",  icon:"ðŸª„", rarity:"R",   slot:"weapon", atk:6,  def:2  },
  { id:"bt_r",  name:"ç–¾é¢¨ãƒ–ãƒ¼ãƒ„",icon:"ðŸ‘Ÿ", rarity:"R",   slot:"acc",    atk:2,  def:4  },
  // SR
  { id:"sw_sr", name:"ç‚Žã®å‰£",    icon:"ðŸ”¥", rarity:"SR",  slot:"weapon", atk:18, def:2  },
  { id:"sh_sr", name:"è–ç›¾",      icon:"âšœï¸", rarity:"SR",  slot:"armor",  atk:2,  def:18 },
  { id:"st_sr", name:"é›·ã®æ–",    icon:"âš¡", rarity:"SR",  slot:"weapon", atk:15, def:5  },
  { id:"rn_sr", name:"å‹‡è€…ã®æŒ‡è¼ª",icon:"ðŸ’«", rarity:"SR",  slot:"acc",    atk:8,  def:8  },
  // SSR
  { id:"sw_ssr",name:"ç¥žå‰£ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼",icon:"âœ´ï¸",rarity:"SSR",slot:"weapon",atk:40,def:10 },
  { id:"st_ssr",name:"è³¢è€…ã®æ–",  icon:"ðŸŒŸ", rarity:"SSR", slot:"weapon", atk:35, def:15 },
  { id:"sh_ssr",name:"ç¥žç›¾ã‚¨ã‚®ã‚¹", icon:"ðŸŒˆ", rarity:"SSR", slot:"armor",  atk:10, def:45 },
  { id:"rn_ssr",name:"ä¸æ­»é³¥ã®æŒ‡è¼ª",icon:"ðŸ¦…",rarity:"SSR",slot:"acc",   atk:20, def:20 },
];

// â”€â”€ Cosmetic pool (titles & frames â†’ appearance only) â”€â”€
const COSM_POOL = [
  // Titles
  { id:"t_rookie",  name:"è¦‹ç¿’ã„å†’é™ºè€…",    type:"title", rarity:"N",   color:"#9ca3af", prefix:"",  suffix:"" },
  { id:"t_brave",   name:"å‹‡æ•¢ãªã‚‹è€…",      type:"title", rarity:"R",   color:"#60a5fa", prefix:"",  suffix:"" },
  { id:"t_crusher", name:"ã‚¯ã‚¨ã‚¹ãƒˆç²‰ç •è€…",  type:"title", rarity:"R",   color:"#60a5fa", prefix:"",  suffix:"" },
  { id:"t_sage",    name:"è³¢è€…",            type:"title", rarity:"SR",  color:"#a855f7", prefix:"",  suffix:"" },
  { id:"t_dragon",  name:"ç«œæ®ºã—",          type:"title", rarity:"SR",  color:"#f97316", prefix:"",  suffix:"" },
  { id:"t_hero",    name:"ä¼èª¬ã®è‹±é›„",      type:"title", rarity:"SSR", color:"#f0c040", prefix:"",  suffix:"" },
  { id:"t_god",     name:"ç¥žã«é¸ã°ã‚Œã—è€…",  type:"title", rarity:"SSR", color:"#ffe88a", prefix:"",  suffix:"" },
  // Frames
  { id:"f_bronze",  name:"ãƒ–ãƒ­ãƒ³ã‚ºæž ",      type:"frame", rarity:"N",   border:"2px solid #cd7f32", shadow:"0 0 8px rgba(205,127,50,0.4)",   gradient:"" },
  { id:"f_silver",  name:"ã‚·ãƒ«ãƒãƒ¼æž ",      type:"frame", rarity:"R",   border:"2px solid #c0c0c0", shadow:"0 0 12px rgba(192,192,192,0.5)", gradient:"" },
  { id:"f_gold",    name:"ã‚´ãƒ¼ãƒ«ãƒ‰æž ",      type:"frame", rarity:"SR",  border:"2px solid #f0c040", shadow:"0 0 18px rgba(240,192,64,0.7)",  gradient:"" },
  { id:"f_rainbow", name:"è™¹è‰²æž ",          type:"frame", rarity:"SSR", border:"3px solid transparent", shadow:"0 0 28px rgba(240,192,64,0.9)", gradient:"linear-gradient(#0a0814,#0a0814) padding-box, linear-gradient(135deg,#f0c040,#a855f7,#3b82f6,#22c55e,#f0c040) border-box" },
  { id:"f_flame",   name:"ç‚Žã®æž ",          type:"frame", rarity:"SR",  border:"2px solid #f97316", shadow:"0 0 18px rgba(249,115,22,0.7)",  gradient:"" },
  { id:"f_void",    name:"è™šç©ºã®æž ",        type:"frame", rarity:"SSR", border:"2px solid #a855f7", shadow:"0 0 28px rgba(168,85,247,0.9)",  gradient:"" },
];

// Full gacha pool
const GACHA_POOL = [...EQUIP_POOL, ...COSM_POOL];
const RARITY_RATES = { SSR:0.02, SR:0.10, R:0.28, N:0.60 };

// â”€â”€ Shop â”€â”€
const SHOP_ITEMS = [
  { id:"pot_s",   name:"ãƒãƒ¼ã‚·ãƒ§ãƒ³",     icon:"ðŸ§ª", desc:"HP +30å›žå¾©",    cost:15,  effect:{ hp:30 } },
  { id:"pot_l",   name:"ãƒã‚¤ãƒãƒ¼ã‚·ãƒ§ãƒ³", icon:"ðŸ’Š", desc:"HP +80å›žå¾©",    cost:40,  effect:{ hp:80 } },
  { id:"ether",   name:"ã‚¨ãƒ¼ãƒ†ãƒ«",       icon:"ðŸ’™", desc:"MP +20å›žå¾©",    cost:20,  effect:{ mp:20 } },
  { id:"elixir",  name:"ã‚¨ãƒªã‚¯ã‚µãƒ¼",     icon:"âœ¨", desc:"HP/MPå…¨å›žå¾©",   cost:120, effect:{ fullHeal:true } },
  { id:"g1",      name:"ã‚¬ãƒãƒ£Ã—1",       icon:"ðŸŽ°", desc:"è£…å‚™&ç§°å·ã‚¬ãƒãƒ£1å›ž",  cost:50,  effect:{ gacha:1  } },
  { id:"g10",     name:"ã‚¬ãƒãƒ£Ã—10",      icon:"ðŸŽ²", desc:"è£…å‚™&ç§°å·ã‚¬ãƒãƒ£10é€£", cost:450, effect:{ gacha:10 } },
];

// â”€â”€ Initial state â”€â”€
const INIT = {
  level:1, xp:0, hp:100, mp:50, gold:50,
  totalXP:0, totalDefeated:0, streak:0,
  tasks:[],
  inventory:[],
  equipped:{ weapon:null, armor:null, acc:null, title:null, frame:null },
  log:[{ msg:"ã‚«ãƒ”ãƒãƒ©å¸ä»¤å®˜ãŒç›®è¦šã‚ãŸï¼", type:"" }],
  profile:{
    name:"ã‚«ãƒ”ãƒãƒ©å¸ä»¤å®˜",
    className:"COMMANDER CLASS",
    icon:"ðŸ¦«",
    iconImage:null,
    gameTitle:"CAPYBARA COMMAND CENTER",
  },
};

function loadState() {
  try {
    const s=localStorage.getItem("ccc_v5");
    if (!s) return INIT;
    const parsed = JSON.parse(s);
    // migrate: ensure profile exists
    if (!parsed.profile) parsed.profile = { ...INIT.profile };
    return parsed;
  }
  catch { return INIT; }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcStats(equipped, inventory) {
  let atk=0, def=0;
  ["weapon","armor","acc"].forEach(slot => {
    const uid = equipped[slot];
    if (!uid) return;
    const inv = inventory.find(i => i.uid === uid);
    if (!inv) return;
    const eq = EQUIP_POOL.find(e => e.id === inv.itemId);
    if (eq) { atk += eq.atk; def += eq.def; }
  });
  return { atk, def };
}

function rollGacha(count) {
  const results = [];
  for (let i = 0; i < count; i++) {
    const r = Math.random();
    let rarity = r < RARITY_RATES.SSR ? "SSR"
      : r < RARITY_RATES.SSR + RARITY_RATES.SR ? "SR"
      : r < RARITY_RATES.SSR + RARITY_RATES.SR + RARITY_RATES.R ? "R" : "N";
    const pool = GACHA_POOL.filter(e => e.rarity === rarity);
    const item = pool[Math.floor(Math.random() * pool.length)];
    results.push({ ...item, uid: Date.now().toString(36) + Math.random().toString(36).slice(2) });
  }
  return results;
}

function playSound(type) {
  try {
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const tone = (f,s,d,v=0.25,wave="sine") => {
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.type=wave; o.connect(g); g.connect(ctx.destination);
      o.frequency.value=f;
      g.gain.setValueAtTime(v, ctx.currentTime+s);
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+s+d);
      o.start(ctx.currentTime+s); o.stop(ctx.currentTime+s+d);
    };
    if (type==="add")      tone(440,0,0.1);
    if (type==="complete") { tone(523,0,0.1); tone(659,0.1,0.1); tone(784,0.2,0.25); }
    if (type==="buy")      { tone(660,0,0.08); tone(880,0.08,0.15); }
    if (type==="equip")    { tone(440,0,0.06); tone(554,0.06,0.12); }
    if (type==="gacha")    { [523,587,659,698,784,880,1046].forEach((f,i)=>tone(f,i*0.06,0.12,0.28)); }
    if (type==="levelup")  { [523,587,659,698,784,880].forEach((f,i)=>tone(f,i*0.08,0.18,0.32)); }
    if (type==="ssr")      { [784,880,988,1047,1175].forEach((f,i)=>tone(f,i*0.1,0.2,0.35,"triangle")); }
  } catch(err){}
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  STYLE CONSTANTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S = {
  panel:  { background:"linear-gradient(135deg,rgba(18,13,36,0.97),rgba(25,17,50,0.97))", border:"1px solid rgba(240,192,64,0.22)", borderRadius:14, padding:18, marginBottom:14, boxShadow:"0 4px 28px rgba(0,0,0,0.55)" },
  ptitle: { fontFamily:"'Cinzel',serif", fontSize:"0.72rem", color:"#f0c040", letterSpacing:"0.15em", textTransform:"uppercase", marginBottom:12, paddingBottom:8, borderBottom:"1px solid rgba(240,192,64,0.18)" },
  input:  { flex:1, background:"rgba(0,0,0,0.4)", border:"1px solid rgba(240,192,64,0.2)", borderRadius:8, padding:"9px 13px", color:"#e8dcc8", fontFamily:"'Noto Sans JP',sans-serif", fontSize:"0.83rem", outline:"none" },
  sel:    { background:"rgba(0,0,0,0.4)", border:"1px solid rgba(240,192,64,0.2)", borderRadius:8, padding:"9px 12px", color:"#e8dcc8", fontFamily:"'Noto Sans JP',sans-serif", fontSize:"0.78rem", outline:"none", cursor:"pointer" },
  btnGold:{ background:"linear-gradient(135deg,#f0c040,#b8860b)", border:"none", borderRadius:8, padding:"9px 18px", color:"#000", fontFamily:"'Cinzel',serif", fontWeight:700, fontSize:"0.78rem", cursor:"pointer", whiteSpace:"nowrap" },
  btnRed: { background:"rgba(220,38,38,0.15)", border:"1px solid rgba(220,38,38,0.3)", borderRadius:6, padding:"5px 10px", color:"#fca5a5", fontSize:"0.62rem", cursor:"pointer" },
  navBtn: a => ({ background:a?"linear-gradient(135deg,rgba(240,192,64,0.18),rgba(240,192,64,0.04))":"rgba(0,0,0,0.3)", border:"1px solid "+(a?"rgba(240,192,64,0.55)":"rgba(240,192,64,0.14)"), borderRadius:8, padding:"8px 4px", color:a?"#f0c040":"#8b7355", fontFamily:"'Cinzel',serif", fontSize:"0.62rem", letterSpacing:"0.06em", cursor:"pointer", flex:1, textAlign:"center" }),
  tabBtn: a => ({ background:a?"rgba(240,192,64,0.1)":"rgba(0,0,0,0.28)", border:"1px solid "+(a?"#f0c040":"rgba(240,192,64,0.14)"), borderRadius:6, padding:"5px 12px", color:a?"#f0c040":"#8b7355", fontFamily:"'Cinzel',serif", fontSize:"0.62rem", cursor:"pointer" }),
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SMALL COMPONENTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Bar({value,max,color}) {
  const pct = Math.max(0,Math.min(100,value/max*100));
  return h('div',{style:{height:9,background:"rgba(0,0,0,0.5)",borderRadius:999,overflow:"hidden",border:"1px solid rgba(255,255,255,0.04)"}},
    h('div',{style:{height:"100%",width:pct+"%",borderRadius:999,transition:"width 0.7s ease",background:color}})
  );
}

function RankBadge({rank}) {
  const rd=RANK_DATA[rank];
  const clr={slime:{c:"#86efac",b:"rgba(134,239,172,0.18)"},goblin:{c:"#a3e635",b:"rgba(163,230,53,0.18)"},dragon:{c:"#f97316",b:"rgba(249,115,22,0.18)"},maou:{c:"#c026d3",b:"rgba(192,38,211,0.18)"}};
  const c=clr[rank];
  return h('span',{style:{display:"inline-flex",alignItems:"center",gap:3,padding:"2px 7px",borderRadius:999,fontSize:"0.6rem",fontWeight:700,background:c.b,color:c.c,border:"1px solid "+c.c+"55"}},rd.emoji+" "+rd.label);
}

function RarityTag({rarity}) {
  const c=RC[rarity];
  return h('span',{style:{padding:"1px 6px",borderRadius:4,fontSize:"0.58rem",fontWeight:700,fontFamily:"'Cinzel',serif",background:c.bg,color:c.color,border:"1px solid "+c.border}},rarity);
}

// Cosmetic card (title or frame)
function CosmCard({item, inv, onEquip, isEquipped}) {
  const cosm = COSM_POOL.find(c=>c.id===item.itemId);
  if (!cosm) return null;
  const c = RC[cosm.rarity];
  const isTitle = cosm.type==="title";
  return h('div',{style:{background:isEquipped?c.bg:"rgba(0,0,0,0.25)",border:"1px solid "+(isEquipped?c.color:"rgba(255,255,255,0.07)"),borderRadius:10,padding:"10px 12px",display:"flex",alignItems:"center",gap:10,marginBottom:6,boxShadow:isEquipped?"0 0 14px "+c.glow:"none",transition:"all 0.2s"}},
    h('div',{style:{fontSize:"1.5rem",flexShrink:0}},isTitle?"ðŸ·ï¸":"ðŸ–¼ï¸"),
    h('div',{style:{flex:1,minWidth:0}},
      h('div',{style:{display:"flex",alignItems:"center",gap:6,marginBottom:3}},
        h('span',{style:{fontSize:"0.8rem",fontWeight:700,color:c.color}},cosm.name),
        h(RarityTag,{rarity:cosm.rarity})
      ),
      h('div',{style:{fontSize:"0.6rem",color:"#8b7355"}},isTitle?"ç§°å·ï¼šã‚­ãƒ£ãƒ©åã®ä¸‹ã«è¡¨ç¤º":"ã‚¢ã‚¤ã‚³ãƒ³æž ï¼šãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³ãŒå¤‰ã‚ã‚‹")
    ),
    h('button',{
      style:{...S.btnGold,fontSize:"0.62rem",padding:"5px 10px",
        background:isEquipped?"rgba(220,38,38,0.3)":"linear-gradient(135deg,#f0c040,#b8860b)",
        border:isEquipped?"1px solid rgba(220,38,38,0.5)":"none",
        color:isEquipped?"#fca5a5":"#000"},
      onClick:()=>onEquip(item.uid, cosm.type==="title"?"title":"frame")
    }, isEquipped?"å¤–ã™":"è£…å‚™")
  );
}

// Equipment card (weapon/armor/acc â†’ stats)
function EquipCard({item, onEquip, isEquipped}) {
  const eq = EQUIP_POOL.find(e=>e.id===item.itemId);
  if (!eq) return null;
  const c = RC[eq.rarity];
  return h('div',{style:{background:isEquipped?c.bg:"rgba(0,0,0,0.25)",border:"1px solid "+(isEquipped?c.color:"rgba(255,255,255,0.07)"),borderRadius:10,padding:"10px 12px",display:"flex",alignItems:"center",gap:10,marginBottom:6,boxShadow:isEquipped?"0 0 14px "+c.glow:"none",transition:"all 0.2s"}},
    h('div',{style:{fontSize:"1.5rem",flexShrink:0}},eq.icon),
    h('div',{style:{flex:1,minWidth:0}},
      h('div',{style:{display:"flex",alignItems:"center",gap:6,marginBottom:3}},
        h('span',{style:{fontSize:"0.8rem",fontWeight:700,color:c.color}},eq.name),
        h(RarityTag,{rarity:eq.rarity})
      ),
      h('div',{style:{fontSize:"0.6rem",color:"#8b7355"}},{weapon:"âš” æ­¦å™¨",armor:"ðŸ›¡ é˜²å…·",acc:"ðŸ’ è£…é£¾"}[eq.slot]+" | ATK+"+eq.atk+" / DEF+"+eq.def)
    ),
    h('button',{
      style:{...S.btnGold,fontSize:"0.62rem",padding:"5px 10px",
        background:isEquipped?"rgba(220,38,38,0.3)":"linear-gradient(135deg,#f0c040,#b8860b)",
        border:isEquipped?"1px solid rgba(220,38,38,0.5)":"none",
        color:isEquipped?"#fca5a5":"#000"},
      onClick:()=>onEquip(item.uid, eq.slot)
    }, isEquipped?"å¤–ã™":"è£…å‚™")
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MAIN APP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [st, setSt]             = useState(loadState);
  const [taskInput, setTaskInput]= useState("");
  const [rankSel, setRankSel]   = useState("slime");
  const [page, setPage]         = useState("quest");
  const [questTab, setQuestTab] = useState("active");
  const [invTab, setInvTab]     = useState("equip");
  // Settings draft state
  const [settingsDraft, setSettingsDraft] = useState(null);
  const [notif, setNotif]       = useState({text:"",show:false});
  const [levelupShow, setLevelupShow] = useState(false);
  const [levelupNum, setLevelupNum]   = useState(1);
  const [gachaRes, setGachaRes]   = useState(null);
  const [gachaPhase, setGachaPhase] = useState("idle"); // idle | chest | reveal | result
  const [revealIdx, setRevealIdx]   = useState(0);       // how many cards revealed so far
  const [ssrFlash, setSsrFlash]     = useState(false);
  const [confetti, setConfetti]     = useState([]);
  const ntRef = useRef(null);

  useEffect(()=>{ try{localStorage.setItem("ccc_v5",JSON.stringify(st));}catch(_){} },[st]);

  const notify = useCallback(msg=>{
    if(ntRef.current) clearTimeout(ntRef.current);
    setNotif({text:msg,show:true});
    ntRef.current=setTimeout(()=>setNotif(n=>({...n,show:false})),2800);
  },[]);

  // â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function addTask() {
    const name=taskInput.trim();
    if(!name){notify("âš  ã‚¯ã‚¨ã‚¹ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
    setSt(p=>({...p,tasks:[...p.tasks,{id:Date.now().toString(),name,rank:rankSel,done:false}],
      log:[{msg:"ã‚¯ã‚¨ã‚¹ãƒˆè¿½åŠ ï¼šã€Œ"+name+"ã€",type:""},...p.log].slice(0,40)}));
    setTaskInput(""); playSound("add");
  }

  function completeTask(id) {
    setSt(p=>{
      const task=p.tasks.find(t=>t.id===id);
      if(!task||task.done) return p;
      const rd=RANK_DATA[task.rank];
      const {atk,def}=calcStats(p.equipped,p.inventory);
      const bonusXP   = Math.floor(rd.xp   * (1+atk/100));
      const bonusGold = Math.floor(rd.gold  * (1+def/100));
      const hpCost    = Math.max(1, rd.hpCost - Math.floor(def/5));
      const mpCost    = Math.max(0, rd.mpCost - Math.floor(atk/20));
      let lv=p.level, xp=p.xp+bonusXP;
      let hp=Math.max(0,p.hp-hpCost), mp=Math.max(0,p.mp-mpCost);
      let didLv=false;
      while(xp>=XP_NEEDED(lv)){xp-=XP_NEEDED(lv);lv++;hp=Math.min(hp+30,MAX_HP(lv));mp=Math.min(mp+15,MAX_MP(lv));didLv=true;}
      const lvGold=didLv?lv*50:0;
      if(didLv) setTimeout(()=>{setLevelupNum(lv);setLevelupShow(true);playSound("levelup");},400);
      playSound("complete");
      notify("âš” "+rd.label+"è¨Žä¼ï¼ EXP +"+bonusXP+" / Gold +"+bonusGold);
      const logs=[...(didLv?[{msg:"Lv."+lv+"ï¼Gold +"+lvGold+" ãƒœãƒ¼ãƒŠã‚¹ï¼",type:"levelup"}]:[]),
        {msg:"ã€Œ"+task.name+"ã€è¨Žä¼ï¼ EXP+"+bonusXP+" Gold+"+bonusGold,type:"victory"}, ...p.log].slice(0,40);
      return{...p,level:lv,xp,hp,mp,gold:p.gold+bonusGold+lvGold,totalXP:p.totalXP+bonusXP,
        totalDefeated:p.totalDefeated+1,streak:p.streak+1,
        tasks:p.tasks.map(t=>t.id===id?{...t,done:true}:t),log:logs};
    });
  }

  function deleteTask(id){setSt(p=>({...p,tasks:p.tasks.filter(t=>t.id!==id)}));}

  function buyItem(item) {
    setSt(p=>{
      if(p.gold<item.cost){notify("ðŸ’° ã‚´ãƒ¼ãƒ«ãƒ‰ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");return p;}
      if(item.effect.gacha){
        const res=rollGacha(item.effect.gacha);
        playSound("gacha");
        startGachaSequence(res);
        const newInv=[...p.inventory,...res.map(r=>({uid:r.uid,itemId:r.id}))];
        return{...p,gold:p.gold-item.cost,inventory:newInv,
          log:[{msg:"ã‚¬ãƒãƒ£"+item.effect.gacha+"å›žï¼"+res.map(r=>r.name).join("ã€")+" ç²å¾—ï¼",type:"victory"},...p.log].slice(0,40)};
      }
      const mxHP=MAX_HP(p.level), mxMP=MAX_MP(p.level);
      let hp=p.hp, mp=p.mp;
      if(item.effect.hp)       hp=Math.min(mxHP,hp+item.effect.hp);
      if(item.effect.mp)       mp=Math.min(mxMP,mp+item.effect.mp);
      if(item.effect.fullHeal){hp=mxHP;mp=mxMP;}
      playSound("buy"); notify("ðŸ›’ "+item.name+"ã‚’è³¼å…¥ï¼");
      return{...p,gold:p.gold-item.cost,hp,mp,
        log:[{msg:item.name+"ã‚’ä½¿ç”¨ï¼",type:"recovery"},...p.log].slice(0,40)};
    });
  }

  function startGachaSequence(results) {
    const hasSSR = results.some(r=>r.rarity==="SSR");
    const hasSR  = results.some(r=>r.rarity==="SR");
    setGachaRes(results);
    setRevealIdx(0);
    setGachaPhase("chest");
    // chest shake â†’ open â†’ reveal cards
    setTimeout(()=>setGachaPhase("reveal"), 1200);
    // SSR flash + confetti â†’ 1å›žã ã‘ã€ã‚«ãƒ¼ãƒ‰å…¨éƒ¨ã‚ãã‚ŒãŸå¾Œã«ç™ºå‹•
    if (hasSSR || hasSR) {
      const totalRevealTime = 1400 + results.length * 200;
      setTimeout(()=>{
        setSsrFlash(hasSSR);
        if (hasSSR) {
          playSound("ssr");
          const pieces = Array.from({length:55},(_,i)=>({
            id:i,
            x: Math.random()*100,
            color:["#f0c040","#a855f7","#3b82f6","#22c55e","#ef4444","#ffe88a"][Math.floor(Math.random()*6)],
            size: 6+Math.random()*8,
            delay: Math.random()*1.2,
            duration: 2+Math.random()*2,
            rotate: Math.random()*360,
          }));
          setConfetti(pieces);
          setTimeout(()=>setConfetti([]), 4000);
        }
        setTimeout(()=>setSsrFlash(false), 600);
      }, totalRevealTime + 100);
    }
    // reveal cards: 10é€£ã¯ä¸€æ°—ã«å…¨è¡¨ç¤ºã€1å›žã¯1æžšã ã‘ã‚ãã‚‹
    if (results.length === 1) {
      setTimeout(()=>setRevealIdx(1), 1400);
    } else {
      // 10é€£ã¯å®ç®±ãŒé–‹ã„ãŸã‚‰å…¨éƒ¨ä¸€æ°—ã«è¡¨ç¤º
      setTimeout(()=>setRevealIdx(results.length), 1200);
    }
  }

  function doGacha(count, cost) {
    setSt(p=>{
      if(p.gold<cost){notify("ðŸ’° ã‚´ãƒ¼ãƒ«ãƒ‰ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");return p;}
      const res=rollGacha(count);
      playSound("gacha");
      startGachaSequence(res);
      const newInv=[...p.inventory,...res.map(r=>({uid:r.uid,itemId:r.id}))];
      return{...p,gold:p.gold-cost,inventory:newInv,
        log:[{msg:"ã‚¬ãƒãƒ£"+count+"å›žï¼"+res.map(r=>r.name).join("ã€")+" ç²å¾—ï¼",type:"victory"},...p.log].slice(0,40)};
    });
  }

  function equipItem(uid, slot) {
    setSt(p=>{
      const isSame=p.equipped[slot]===uid;
      const newEq={...p.equipped,[slot]:isSame?null:uid};
      playSound("equip");
      if(!isSame){
        const inv=p.inventory.find(i=>i.uid===uid);
        const allPool=[...EQUIP_POOL,...COSM_POOL];
        const item=allPool.find(e=>e.id===(inv||{}).itemId);
        notify("âœ¨ "+(item?item.name:"è£…å‚™")+"ã‚’è£…å‚™ï¼");
      } else { notify("è£…å‚™ã‚’å¤–ã—ãŸ"); }
      return{...p,equipped:newEq};
    });
  }

  function removeItem(uid) {
    setSt(p=>({...p,inventory:p.inventory.filter(i=>i.uid!==uid),
      equipped:Object.fromEntries(Object.entries(p.equipped).map(([k,v])=>[k,v===uid?null:v]))}));
  }

  function openSettings() {
    setSettingsDraft({ ...(st.profile || INIT.profile) });
    setPage("settings");
  }

  function saveSettings() {
    if (!settingsDraft) return;
    setSt(p=>({ ...p, profile:{ ...settingsDraft } }));
    notify("âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
    setPage("quest");
  }

  function handleIconUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      setSettingsDraft(d=>({ ...d, iconImage: ev.target.result, icon:"" }));
    };
    reader.readAsDataURL(file);
  }

  function exportData() {
    try {
      const json = JSON.stringify(st, null, 2);
      const blob = new Blob([json], { type:"application/json" });
      const url  = URL.createObjectURL(blob);
      const date = new Date().toISOString().slice(0,10);
      const a    = document.createElement("a");
      a.href     = url;
      a.download = "capybara-save-" + date + ".json";
      a.click();
      URL.revokeObjectURL(url);
      notify("ðŸ’¾ ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼");
    } catch(err) { notify("âš  ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ"); }
  }

  function importData(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const parsed = JSON.parse(ev.target.result);
        // ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (typeof parsed.level !== "number" || !Array.isArray(parsed.tasks)) {
          notify("âš  æ­£ã—ã„ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã§ã¯ã‚ã‚Šã¾ã›ã‚“"); return;
        }
        if (!parsed.profile) parsed.profile = { ...INIT.profile };
        setSt(parsed);
        notify("âœ… ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼");
        setPage("quest");
      } catch(_) { notify("âš  ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
    };
    reader.readAsText(file);
  }

  function resetData() {
    if (!window.confirm("âš  å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) return;
    setSt({ ...INIT });
    localStorage.removeItem("ccc_v5");
    notify("ðŸ—‘ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
    setPage("quest");
  }

  // â”€â”€ Derived â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const lv   = st.level;
  const prof = st.profile || INIT.profile;
  const {atk,def} = calcStats(st.equipped, st.inventory);
  const activeTasks    = st.tasks.filter(t=>!t.done);
  const completedTasks = st.tasks.filter(t=> t.done);

  // Get equipped cosmetics
  const equippedTitle = st.equipped.title
    ? COSM_POOL.find(c=>c.id===(st.inventory.find(i=>i.uid===st.equipped.title)||{}).itemId) : null;
  const equippedFrame = st.equipped.frame
    ? COSM_POOL.find(c=>c.id===(st.inventory.find(i=>i.uid===st.equipped.frame)||{}).itemId) : null;

  // Frame style
  const frameStyle = equippedFrame
    ? { border:equippedFrame.border, boxShadow:equippedFrame.shadow, background:equippedFrame.gradient||undefined }
    : { border:"2px solid #f0c040", boxShadow:"0 0 14px rgba(240,192,64,0.3)" };

  // â”€â”€ Page renderers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function renderQuest() {
    return h('div',null,
      h('div',{style:S.panel},
        h('div',{style:S.ptitle},"âš” æ–°ã—ã„ã‚¯ã‚¨ã‚¹ãƒˆè¿½åŠ "),
        h('div',{style:{display:"flex",gap:8,flexWrap:"wrap"}},
          h('input',{style:S.input,value:taskInput,onChange:ev=>setTaskInput(ev.target.value),onKeyDown:ev=>ev.key==="Enter"&&addTask(),placeholder:"ã‚¯ã‚¨ã‚¹ãƒˆåã‚’å…¥åŠ›...",maxLength:60}),
          h('select',{style:S.sel,value:rankSel,onChange:ev=>setRankSel(ev.target.value)},
            h('option',{value:"slime"},"ðŸŸ¢ ã‚¹ãƒ©ã‚¤ãƒ "),
            h('option',{value:"goblin"},"ðŸŸ¡ ã‚´ãƒ–ãƒªãƒ³"),
            h('option',{value:"dragon"},"ðŸŸ  ãƒ‰ãƒ©ã‚´ãƒ³"),
            h('option',{value:"maou"},"ðŸŸ£ é­”çŽ‹")
          ),
          h('button',{style:S.btnGold,onClick:addTask},"è¿½åŠ ")
        )
      ),
      h('div',{style:S.panel},
        h('div',{style:S.ptitle},"ðŸ“œ ã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ¼ãƒ‰"),
        h('div',{style:{display:"flex",gap:8,marginBottom:12}},
          h('button',{style:S.tabBtn(questTab==="active"),   onClick:()=>setQuestTab("active")},"é€²è¡Œä¸­ "+activeTasks.length),
          h('button',{style:S.tabBtn(questTab==="completed"),onClick:()=>setQuestTab("completed")},"å®Œäº†æ¸ˆã¿ "+completedTasks.length)
        ),
        questTab==="active" && (
          activeTasks.length===0
            ? h('div',{style:{textAlign:"center",padding:24,color:"#8b7355",fontSize:"0.78rem"}},h('div',{style:{fontSize:"2rem",marginBottom:6}},"ðŸ›¡ï¸"),"ã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½åŠ ã—ã‚ˆã†ï¼")
            : h('div',null,activeTasks.map(t=>{
                const rd=RANK_DATA[t.rank];
                return h('div',{key:t.id,style:{background:"rgba(0,0,0,0.25)",border:"1px solid rgba(240,192,64,0.09)",borderRadius:10,padding:"11px 13px",display:"flex",alignItems:"center",gap:10,marginBottom:7}},
                  h('div',{style:{width:26,height:26,borderRadius:"50%",border:"2px solid #8b7355",cursor:"pointer",flexShrink:0},onClick:()=>completeTask(t.id)}),
                  h('div',{style:{flex:1,minWidth:0}},
                    h('div',{style:{fontSize:"0.82rem",marginBottom:3}},t.name),
                    h('div',{style:{display:"flex",alignItems:"center",gap:7}},
                      h(RankBadge,{rank:t.rank}),
                      h('span',{style:{fontSize:"0.6rem",color:"#f0c040",fontFamily:"'Cinzel',serif"}},"EXP+"+rd.xp+" / G+"+rd.gold)
                    )
                  ),
                  h('button',{style:S.btnRed,onClick:()=>deleteTask(t.id)},"å‰Šé™¤")
                );
              }))
        ),
        questTab==="completed" && (
          completedTasks.length===0
            ? h('div',{style:{textAlign:"center",padding:24,color:"#8b7355",fontSize:"0.78rem"}},"è¨Žä¼è¨˜éŒ²ãªã—")
            : h('div',null,completedTasks.map(t=>
                h('div',{key:t.id,style:{background:"rgba(0,0,0,0.14)",border:"1px solid rgba(255,255,255,0.04)",borderRadius:10,padding:"11px 13px",display:"flex",alignItems:"center",gap:10,marginBottom:7,opacity:0.5}},
                  h('div',{style:{width:26,height:26,borderRadius:"50%",border:"2px solid #f0c040",background:"#f0c040",flexShrink:0,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.75rem"}},"âœ“"),
                  h('div',{style:{flex:1}},
                    h('div',{style:{fontSize:"0.82rem",textDecoration:"line-through",color:"#8b7355",marginBottom:3}},t.name),
                    h(RankBadge,{rank:t.rank})
                  ),
                  h('button',{style:S.btnRed,onClick:()=>deleteTask(t.id)},"å‰Šé™¤")
                )
              ))
        )
      ),
      // Battle log
      h('div',{style:S.panel},
        h('div',{style:S.ptitle},"ðŸ“œ ãƒãƒˆãƒ«ãƒ­ã‚°"),
        h('div',{style:{display:"flex",flexDirection:"column",gap:3,maxHeight:120,overflowY:"auto"}},
          st.log.map((item,i)=>{
            const en=typeof item==="string"?{msg:item,type:""}:item;
            const clr={victory:"#ffe88a",recovery:"#60a5fa",levelup:"#c084fc","":"#8b7355"};
            return h('div',{key:i,style:{fontSize:"0.67rem",padding:"3px 7px",borderRadius:5,background:"rgba(0,0,0,0.18)",color:clr[en.type]||"#8b7355"}},"â–¶ "+en.msg);
          })
        )
      )
    );
  }

  function renderShop() {
    return h('div',{style:S.panel},
      h('div',{style:S.ptitle},"ðŸ›’ ã‚·ãƒ§ãƒƒãƒ—"),
      h('div',{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}},
        SHOP_ITEMS.map(item=>
          h('div',{key:item.id,style:{background:"rgba(0,0,0,0.28)",border:"1px solid rgba(240,192,64,0.14)",borderRadius:10,padding:"12px",display:"flex",flexDirection:"column",gap:6}},
            h('div',{style:{display:"flex",alignItems:"center",gap:8}},
              h('span',{style:{fontSize:"1.4rem"}},item.icon),
              h('div',null,
                h('div',{style:{fontSize:"0.8rem",fontWeight:700,color:"#e8dcc8"}},item.name),
                h('div',{style:{fontSize:"0.6rem",color:"#8b7355"}},item.desc)
              )
            ),
            h('div',{style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},
              h('span',{style:{fontFamily:"'Cinzel',serif",fontSize:"0.78rem",color:"#f0c040"}},"ðŸ’° "+item.cost+"G"),
              h('button',{style:{...S.btnGold,fontSize:"0.65rem",padding:"5px 11px",opacity:st.gold>=item.cost?1:0.4},onClick:()=>buyItem(item)},"è³¼å…¥")
            )
          )
        )
      )
    );
  }

  function renderInventory() {
    const equipInv  = st.inventory.filter(i=>EQUIP_POOL.find(e=>e.id===i.itemId));
    const cosmInv   = st.inventory.filter(i=>COSM_POOL.find(c=>c.id===i.itemId));
    const titleInv  = cosmInv.filter(i=>{ const c=COSM_POOL.find(c=>c.id===i.itemId); return c&&c.type==="title"; });
    const frameInv  = cosmInv.filter(i=>{ const c=COSM_POOL.find(c=>c.id===i.itemId); return c&&c.type==="frame"; });

    const tabs=[["equip","âš” è£…å‚™"],["title","ðŸ· ç§°å·"],["frame","ðŸ–¼ æž "]];
    const listed = invTab==="equip"?equipInv:invTab==="title"?titleInv:frameInv;

    return h('div',null,
      // Currently equipped display
      h('div',{style:S.panel},
        h('div',{style:S.ptitle},"âœ¨ ç¾åœ¨ã®è£…å‚™"),
        // Stats row
        h('div',{style:{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:8,marginBottom:12}},
          [["weapon","âš” æ­¦å™¨"],["armor","ðŸ›¡ é˜²å…·"],["acc","ðŸ’ è£…é£¾"]].map(([slot,lbl])=>{
            const uid=st.equipped[slot];
            const inv=uid&&st.inventory.find(i=>i.uid===uid);
            const eq=inv&&EQUIP_POOL.find(e=>e.id===inv.itemId);
            const c=eq?RC[eq.rarity]:null;
            return h('div',{key:slot,style:{background:eq?c.bg:"rgba(0,0,0,0.2)",border:"1px solid "+(eq?c.color:"rgba(255,255,255,0.05)"),borderRadius:9,padding:10,textAlign:"center",display:"flex",flexDirection:"column",alignItems:"center",gap:3}},
              h('div',{style:{fontSize:eq?"1.6rem":"1rem",opacity:eq?1:0.3}},eq?eq.icon:["âš”ï¸","ðŸ›¡ï¸","ðŸ’"][["weapon","armor","acc"].indexOf(slot)]),
              h('div',{style:{fontSize:"0.6rem",color:eq?c.color:"#8b7355",fontFamily:"'Cinzel',serif",fontWeight:700}},eq?eq.name:lbl+" (ç©º)"),
              eq&&h('div',{style:{fontSize:"0.56rem",color:"#8b7355"}},"ATK+"+eq.atk+" / DEF+"+eq.def)
            );
          })
        ),
        // Cosmetic row
        h('div',{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}},
          [["title","ðŸ· ç§°å·"],["frame","ðŸ–¼ ã‚¢ã‚¤ã‚³ãƒ³æž "]].map(([slot,lbl])=>{
            const uid=st.equipped[slot];
            const inv=uid&&st.inventory.find(i=>i.uid===uid);
            const cosm=inv&&COSM_POOL.find(c=>c.id===inv.itemId);
            const c=cosm?RC[cosm.rarity]:null;
            return h('div',{key:slot,style:{background:cosm?c.bg:"rgba(0,0,0,0.2)",border:"1px solid "+(cosm?c.color:"rgba(255,255,255,0.05)"),borderRadius:9,padding:"10px 12px",display:"flex",alignItems:"center",gap:8}},
              h('div',{style:{fontSize:"1.2rem",opacity:cosm?1:0.3}},slot==="title"?"ðŸ·ï¸":"ðŸ–¼ï¸"),
              h('div',null,
                h('div',{style:{fontSize:"0.62rem",color:cosm?c.color:"#8b7355",fontFamily:"'Cinzel',serif",fontWeight:700}},cosm?cosm.name:lbl+" (æœªè£…å‚™)"),
                cosm&&h('div',{style:{fontSize:"0.56rem",color:"#8b7355"}},slot==="title"?"ç§°å·ã¨ã—ã¦è¡¨ç¤ºä¸­":"æž ã¨ã—ã¦è¡¨ç¤ºä¸­")
              )
            );
          })
        )
      ),
      // Inventory list
      h('div',{style:S.panel},
        h('div',{style:S.ptitle},"ðŸŽ’ æ‰€æŒå“ ("+st.inventory.length+"å€‹)"),
        h('div',{style:{display:"flex",gap:6,marginBottom:12}},
          tabs.map(([k,l])=>h('button',{key:k,style:S.tabBtn(invTab===k),onClick:()=>setInvTab(k)},l))
        ),
        listed.length===0
          ? h('div',{style:{textAlign:"center",padding:24,color:"#8b7355",fontSize:"0.78rem"}},h('div',{style:{fontSize:"1.8rem",marginBottom:6}},"ðŸ“¦"),"ã‚¬ãƒãƒ£ã‚’å›žã—ã¦å…¥æ‰‹ã—ã‚ˆã†ï¼")
          : h('div',null,listed.map(item=>{
              const isEq=Object.values(st.equipped).includes(item.uid);
              const isEquip=EQUIP_POOL.find(e=>e.id===item.itemId);
              const isCosmItem=COSM_POOL.find(c=>c.id===item.itemId);
              if(isEquip)    return h(EquipCard,{key:item.uid,item,onEquip:equipItem,isEquipped:isEq});
              if(isCosmItem) return h(CosmCard, {key:item.uid,item,inv:st.inventory,onEquip:equipItem,isEquipped:isEq});
              return null;
            }))
      )
    );
  }

  function renderGacha() {
    return h('div',null,
      h('div',{style:S.panel},
        h('div',{style:S.ptitle},"ðŸŽ° ã‚¬ãƒãƒ£"),
        h('div',{style:{textAlign:"center",marginBottom:20}},
          h('div',{style:{fontSize:"3.5rem",marginBottom:8}},"ðŸŽ²"),
          h('div',{style:{color:"#8b7355",fontSize:"0.76rem",marginBottom:16}},"è£…å‚™ãƒ»ç§°å·ãƒ»ã‚¢ã‚¤ã‚³ãƒ³æž ã‚’ã‚²ãƒƒãƒˆï¼"),
          h('div',{style:{display:"flex",justifyContent:"center",gap:10,flexWrap:"wrap"}},
            [{label:"1å›žã‚¬ãƒãƒ£",cost:50,count:1},{label:"10é€£ã‚¬ãƒãƒ£",cost:450,count:10}].map(g=>
              h('button',{key:g.count,style:{...S.btnGold,fontSize:"0.8rem",padding:"12px 22px",opacity:st.gold>=g.cost?1:0.45},
                onClick:()=>doGacha(g.count,g.cost)},
                g.label+" (ðŸ’°"+g.cost+"G)")
            )
          )
        ),
        // Rate table
        h('div',{style:{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:8,marginBottom:16}},
          [["SSR","2%"],["SR","10%"],["R","28%"],["N","60%"]].map(([r,rate])=>{
            const c=RC[r];
            return h('div',{key:r,style:{background:c.bg,border:"1px solid "+c.border,borderRadius:9,padding:"10px 6px",textAlign:"center"}},
              h('div',{style:{fontFamily:"'Cinzel',serif",fontSize:"1rem",fontWeight:900,color:c.color}},r),
              h('div',{style:{fontSize:"0.6rem",color:"#8b7355",marginTop:3}},rate)
            );
          })
        ),
        // What you can get
        h('div',{style:{background:"rgba(0,0,0,0.2)",borderRadius:10,padding:"12px 14px"}},
          h('div',{style:{fontSize:"0.68rem",color:"#f0c040",fontFamily:"'Cinzel',serif",marginBottom:8}},"â–Œ æŽ’å‡ºã‚¢ã‚¤ãƒ†ãƒ "),
          h('div',{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:4}},
            [["âš”ï¸ æ­¦å™¨","ATKå¼·åŒ–ï¼ˆè¨Žä¼å ±é…¬UPï¼‰"],["ðŸ›¡ï¸ é˜²å…·","DEFå¼·åŒ–ï¼ˆæ¶ˆè€—ã‚³ã‚¹ãƒˆæ¸›ï¼‰"],["ðŸ·ï¸ ç§°å·","ã‚­ãƒ£ãƒ©åä¸‹ã«è¡¨ç¤º"],["ðŸ–¼ï¸ ã‚¢ã‚¤ã‚³ãƒ³æž ","ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰åŒ–"]].map(([icon,desc])=>
              h('div',{key:icon,style:{display:"flex",alignItems:"center",gap:6,fontSize:"0.62rem",color:"#8b7355"}},
                h('span',null,icon), h('span',null,desc)
              )
            )
          )
        )
      )
    );
  }

  // â”€â”€ Settings Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderSettings() {
    if (!settingsDraft) return null;
    const d = settingsDraft;
    const labelStyle = { fontSize:"0.68rem", color:"#8b7355", fontFamily:"'Cinzel',serif", letterSpacing:"0.1em", textTransform:"uppercase", marginBottom:5, display:"block" };
    const fieldInput = { width:"100%", background:"rgba(0,0,0,0.4)", border:"1px solid rgba(240,192,64,0.2)", borderRadius:8, padding:"9px 13px", color:"#e8dcc8", fontFamily:"'Noto Sans JP',sans-serif", fontSize:"0.83rem", outline:"none" };

    // Emoji presets
    const emojiPresets = ["ðŸ¦«","ðŸ»","ðŸº","ðŸ¦Š","ðŸ±","ðŸ¸","ðŸ²","ðŸ¦","ðŸ¼","ðŸ¨","ðŸ¦„","ðŸ™","ðŸ¦‹","ðŸ‘¾","ðŸ¤–","ðŸ§™","âš”ï¸","ðŸ›¡ï¸","ðŸŒŸ"];

    return h('div',null,
      h('div',{style:S.panel},
        h('div',{style:S.ptitle},"âš™ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š"),

        // Preview
        h('div',{style:{display:"flex",alignItems:"center",gap:14,marginBottom:20,background:"rgba(0,0,0,0.2)",borderRadius:10,padding:"14px"}},
          h('div',{style:{width:72,height:72,borderRadius:10,border:"2px solid #f0c040",overflow:"hidden",background:"rgba(0,0,0,0.3)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"2.5rem",flexShrink:0,boxShadow:"0 0 12px rgba(240,192,64,0.3)"}},
            d.iconImage ? h('img',{src:d.iconImage,style:{width:"100%",height:"100%",objectFit:"cover"}}) : (d.icon||"ðŸ¦«")
          ),
          h('div',null,
            h('div',{style:{fontFamily:"'Cinzel',serif",fontSize:"1rem",color:"#ffe88a",marginBottom:3}},d.name||"åå‰æœªè¨­å®š"),
            h('div',{style:{color:"#a855f7",fontSize:"0.65rem",letterSpacing:"0.12em"}},"â˜… "+(d.className||"CLASS NAME")+" â˜…"),
            h('div',{style:{color:"#8b7355",fontSize:"0.58rem",marginTop:4}},"ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼")
          )
        ),

        // Name
        h('div',{style:{marginBottom:14}},
          h('label',{style:labelStyle},"ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å"),
          h('input',{style:fieldInput, value:d.name, maxLength:20,
            onChange:ev=>setSettingsDraft(p=>({...p,name:ev.target.value})),
            placeholder:"ã‚«ãƒ”ãƒãƒ©å¸ä»¤å®˜"})
        ),

        // Class name
        h('div',{style:{marginBottom:14}},
          h('label',{style:labelStyle},"ã‚¯ãƒ©ã‚¹å"),
          h('input',{style:fieldInput, value:d.className, maxLength:24,
            onChange:ev=>setSettingsDraft(p=>({...p,className:ev.target.value})),
            placeholder:"COMMANDER CLASS"})
        ),

        // Game title
        h('div',{style:{marginBottom:20}},
          h('label',{style:labelStyle},"ã‚²ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«"),
          h('input',{style:fieldInput, value:d.gameTitle, maxLength:30,
            onChange:ev=>setSettingsDraft(p=>({...p,gameTitle:ev.target.value})),
            placeholder:"CAPYBARA COMMAND CENTER"})
        ),

        // Icon section
        h('div',{style:{marginBottom:14}},
          h('label',{style:labelStyle},"ã‚¢ã‚¤ã‚³ãƒ³çµµæ–‡å­—ï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰é¸ã¶ï¼‰"),
          h('div',{style:{display:"flex",flexWrap:"wrap",gap:6,marginBottom:10}},
            emojiPresets.map(emoji=>
              h('button',{key:emoji,
                style:{fontSize:"1.4rem",padding:"6px 8px",borderRadius:8,border:"1px solid "+(d.icon===emoji&&!d.iconImage?"rgba(240,192,64,0.7)":"rgba(255,255,255,0.08)"),background:d.icon===emoji&&!d.iconImage?"rgba(240,192,64,0.12)":"rgba(0,0,0,0.3)",cursor:"pointer",transition:"all 0.15s"},
                onClick:()=>setSettingsDraft(p=>({...p,icon:emoji,iconImage:null}))},
                emoji)
            )
          ),
          h('label',{style:labelStyle},"ã¾ãŸã¯ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"),
          h('div',{style:{display:"flex",alignItems:"center",gap:10}},
            h('label',{style:{...S.btnGold,display:"inline-block",cursor:"pointer"}},
              "ðŸ“ ç”»åƒã‚’é¸ã¶",
              h('input',{type:"file",accept:"image/*",style:{display:"none"},onChange:handleIconUpload})
            ),
            d.iconImage && h('button',{style:{...S.btnRed,padding:"8px 12px"},
              onClick:()=>setSettingsDraft(p=>({...p,iconImage:null,icon:"ðŸ¦«"}))},
              "ç”»åƒã‚’ãƒªã‚»ãƒƒãƒˆ")
          )
        ),

        // Buttons
        h('div',{style:{display:"flex",gap:10,marginTop:8}},
          h('button',{style:{...S.btnGold,flex:1,padding:"11px"},onClick:saveSettings},"ðŸ’¾ ä¿å­˜ã™ã‚‹"),
          h('button',{style:{background:"rgba(0,0,0,0.3)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:8,padding:"11px",color:"#8b7355",cursor:"pointer",flex:1},onClick:()=>setPage("quest")},"ã‚­ãƒ£ãƒ³ã‚»ãƒ«")
        )
      ),

      // â”€â”€ Data Management â”€â”€
      h('div',{style:S.panel},
        h('div',{style:S.ptitle},"ðŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†"),

        // Export
        h('div',{style:{marginBottom:14}},
          h('div',{style:{fontSize:"0.75rem",color:"#e8dcc8",fontWeight:700,marginBottom:4}},"ðŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰"),
          h('div',{style:{fontSize:"0.65rem",color:"#8b7355",marginBottom:8}},
            "ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ¶ˆã™å‰ã«å¿…ãšè¡Œã£ã¦ãã ã•ã„ã€‚"
          ),
          h('button',{style:{...S.btnGold,width:"100%",padding:"10px"},onClick:exportData},
            "ðŸ“¤ ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
          )
        ),

        h('div',{style:{height:1,background:"rgba(255,255,255,0.06)",marginBottom:14}}),

        // Import
        h('div',{style:{marginBottom:14}},
          h('div',{style:{fontSize:"0.75rem",color:"#e8dcc8",fontWeight:700,marginBottom:4}},"ðŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿å¾©å…ƒï¼‰"),
          h('div',{style:{fontSize:"0.65rem",color:"#8b7355",marginBottom:8}},
            "ä»¥å‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚"
          ),
          h('label',{style:{...S.btnGold,display:"block",textAlign:"center",padding:"10px",cursor:"pointer",width:"100%"}},
            "ðŸ“¥ ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€",
            h('input',{type:"file",accept:".json,application/json",style:{display:"none"},onChange:importData})
          )
        ),

        h('div',{style:{height:1,background:"rgba(255,255,255,0.06)",marginBottom:14}}),

        // Reset
        h('div',null,
          h('div',{style:{fontSize:"0.75rem",color:"#fca5a5",fontWeight:700,marginBottom:4}},"ðŸ—‘ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ"),
          h('div',{style:{fontSize:"0.65rem",color:"#8b7355",marginBottom:8}},
            "âš  å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ¬ãƒ™ãƒ«ãƒ»è£…å‚™ãƒ»ã‚¯ã‚¨ã‚¹ãƒˆï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚"
          ),
          h('button',{
            style:{background:"rgba(220,38,38,0.15)",border:"1px solid rgba(220,38,38,0.4)",borderRadius:8,padding:"10px",color:"#fca5a5",fontSize:"0.78rem",cursor:"pointer",width:"100%"},
            onClick:resetData
          },"ðŸ—‘ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹")
        )
      )
    );
  }

  // â”€â”€ Gacha Result Modal (animated) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function GachaModal() {
    if(!gachaRes || gachaPhase==="idle") return null;
    const hasSSR = gachaRes.some(r=>r.rarity==="SSR");
    const hasSR  = gachaRes.some(r=>r.rarity==="SR");
    const borderCol = hasSSR?"#f0c040":hasSR?"#a855f7":"rgba(240,192,64,0.35)";

    function closeModal() {
      setGachaPhase("idle");
      setGachaRes(null);
      setRevealIdx(0);
      setSsrFlash(false);
      setConfetti([]);
    }

    return h('div',null,
      // SSR screen flash overlay
      ssrFlash && h('div',{style:{position:"fixed",inset:0,zIndex:1100,pointerEvents:"none",
        background:"radial-gradient(circle,rgba(240,192,64,0.6) 0%,rgba(240,192,64,0.1) 60%,transparent 100%)",
        animation:"ssrFlash 0.8s ease forwards"}}),

      // Confetti
      confetti.length>0 && h('div',{style:{position:"fixed",inset:0,zIndex:1099,pointerEvents:"none",overflow:"hidden"}},
        confetti.map(p=>h('div',{key:p.id,style:{
          position:"absolute", left:p.x+"%", top:"-10px",
          width:p.size+"px", height:p.size+"px",
          background:p.color, borderRadius:p.size>10?"50%":"2px",
          animation:"confettiFall "+(p.duration)+"s "+(p.delay)+"s ease-in forwards",
          transform:"rotate("+p.rotate+"deg)",
        }}))
      ),

      // Main modal
      h('div',{
        style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.93)",zIndex:1000,
          display:"flex",alignItems:"center",justifyContent:"center",padding:16,
          animation: ssrFlash ? "ssrShake 0.4s ease" : "none"}},

        // CHEST PHASEï¼ˆå®ç®±ï¼‰
        gachaPhase==="chest" && h('div',{style:{textAlign:"center"}},
          h('div',{style:{fontSize:"7rem",display:"block",animation:"chestShake 0.4s ease infinite",transformOrigin:"bottom center",lineHeight:1,marginBottom:16}},"ðŸ“¦"),
          h('div',{style:{fontFamily:"'Cinzel',serif",fontSize:"1.2rem",color:"#f0c040",marginTop:8,
            animation:"glowPulse 0.8s ease infinite"}},"Opening...")
        ),

        // REVEAL PHASE
        gachaPhase==="reveal" && h('div',{
          style:{background:"linear-gradient(135deg,#0a0814,#160a2e)",border:"2px solid "+borderCol,
            borderRadius:20,padding:"22px 18px",maxWidth:480,width:"100%",
            maxHeight:"90vh",overflowY:"auto",WebkitOverflowScrolling:"touch",
            boxShadow:hasSSR?"0 0 80px rgba(240,192,64,0.6)":hasSR?"0 0 50px rgba(168,85,247,0.5)":"none",
            animation:"popIn 0.35s cubic-bezier(0.34,1.56,0.64,1)"}},

          // Header
          h('div',{style:{textAlign:"center",marginBottom:14}},
            h('div',{style:{fontSize:hasSSR?"2.8rem":"2rem",marginBottom:4,
              animation:hasSSR?"glowPulse 1s ease infinite":"none",
              color:hasSSR?"#f0c040":hasSR?"#a855f7":"#e8dcc8"}},
              hasSSR?"âœ¨ðŸŒŸâœ¨":hasSR?"ðŸ’«â­ðŸ’«":"ðŸŽ‰"),
            h('div',{style:{fontFamily:"'Cinzel',serif",fontSize:"1.4rem",
              color:hasSSR?"#f0c040":hasSR?"#a855f7":"#e8dcc8",marginBottom:4,
              animation:hasSSR||hasSR?"glowPulse 1.2s ease infinite":"none"}},
              hasSSR?"âœ¦ SSR CONFIRMED âœ¦":hasSR?"â˜… SR GET â˜…":"GACHA RESULT!"),
            h('div',{style:{fontSize:"0.6rem",color:"#8b7355"}},"ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹")
          ),

          // Cards
          h('div',{style:{display:"flex",flexDirection:"column",gap:8}},
            gachaRes.map((item,i)=>{
              const c = RC[item.rarity];
              const isCosmResult = COSM_POOL.find(c=>c.id===item.id);
              const isVisible = i < revealIdx;
              if (!isVisible) return h('div',{key:i,style:{height:58,borderRadius:10,background:"rgba(0,0,0,0.3)",border:"1px solid rgba(255,255,255,0.06)"}});
              return h('div',{key:i,style:{
                background:c.bg, border:"1px solid "+c.color, borderRadius:10,
                padding:"10px 13px", display:"flex", alignItems:"center", gap:10,
                animation:"cardFlip 0.35s ease both",
                boxShadow:item.rarity==="SSR"?"0 0 20px "+c.glow:item.rarity==="SR"?"0 0 12px "+c.glow:"none",
              }},
                h('div',{style:{fontSize:"1.6rem",flexShrink:0}},
                  isCosmResult?(isCosmResult.type==="title"?"ðŸ·ï¸":"ðŸ–¼ï¸"):item.icon||"â“"),
                h('div',{style:{flex:1}},
                  h('div',{style:{display:"flex",alignItems:"center",gap:6,marginBottom:3}},
                    h('span',{style:{fontSize:"0.85rem",fontWeight:700,color:c.color,
                      animation:item.rarity==="SSR"?"glowPulse 1s ease infinite":"none"}},item.name),
                    h(RarityTag,{rarity:item.rarity}),
                    isCosmResult&&h('span',{style:{fontSize:"0.58rem",color:"#8b7355",background:"rgba(0,0,0,0.3)",padding:"1px 5px",borderRadius:4}},
                      isCosmResult.type==="title"?"ç§°å·":"æž ")
                  ),
                  !isCosmResult&&h('div',{style:{fontSize:"0.6rem",color:"#8b7355"}},"ATK+"+item.atk+" / DEF+"+item.def),
                  isCosmResult&&h('div',{style:{fontSize:"0.6rem",color:"#8b7355"}},
                    isCosmResult.type==="title"?"ã‚­ãƒ£ãƒ©åä¸‹ã«è¡¨ç¤ºã§ãã‚‹ç§°å·":"ã‚¢ã‚¤ã‚³ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å¤‰æ›´ã§ãã‚‹")
                )
              );
            })
          ),

          // Close button (shows after all revealed)
          revealIdx >= gachaRes.length && h('div',{style:{textAlign:"center",marginTop:16}},
            h('button',{style:{...S.btnGold,padding:"10px 32px"},onClick:closeModal},"OKï¼")
          )
        )
      )
    );
  }

  // â”€â”€ Main render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  return h('div',{style:{background:"#0a0814",color:"#e8dcc8",fontFamily:"'Noto Sans JP',sans-serif",minHeight:"100vh",backgroundImage:"radial-gradient(ellipse at 20% 50%,rgba(107,33,168,0.12) 0%,transparent 60%),radial-gradient(ellipse at 80% 20%,rgba(59,130,246,0.08) 0%,transparent 50%)"}},

    // Notification
    h('div',{style:{position:"fixed",top:16,left:"50%",transform:"translateX(-50%) translateY("+(notif.show?"0":"-70px")+")",background:"rgba(12,8,24,0.98)",border:"1px solid #f0c040",borderRadius:12,padding:"10px 20px",fontFamily:"'Cinzel',serif",fontSize:"0.8rem",color:"#f0c040",zIndex:1001,boxShadow:"0 0 24px rgba(240,192,64,0.4)",transition:"transform 0.35s cubic-bezier(0.34,1.56,0.64,1)",whiteSpace:"nowrap",pointerEvents:"none"}},notif.text),

    // Level up overlay
    levelupShow && h('div',{onClick:()=>setLevelupShow(false),style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.88)",zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center"}},
      h('div',{style:{background:"linear-gradient(135deg,#0a0814,#1e0d3c)",border:"2px solid #f0c040",borderRadius:20,padding:"36px 52px",textAlign:"center",boxShadow:"0 0 60px rgba(240,192,64,0.5)",animation:"popIn 0.4s cubic-bezier(0.34,1.56,0.64,1)"}},
        h('div',{style:{fontSize:"2.5rem",marginBottom:6}},"ðŸŽ‰"),
        h('div',{style:{fontFamily:"'Cinzel',serif",fontSize:"2rem",color:"#f0c040",marginBottom:4}},"LEVEL UP!"),
        h('div',{style:{fontFamily:"'Cinzel',serif",fontSize:"5rem",fontWeight:900,color:"#ffe88a",lineHeight:1,marginBottom:10,textShadow:"0 0 30px rgba(240,192,64,0.8)"}},levelupNum),
        h('div',{style:{color:"#8b7355",fontSize:"0.75rem",marginBottom:4}},"ã‚«ãƒ”ãƒãƒ©å¸ä»¤å®˜ãŒå¼·ããªã£ãŸï¼"),
        h('div',{style:{color:"#f0c040",fontFamily:"'Cinzel',serif",fontSize:"0.7rem",marginBottom:20}},"ðŸ’° Gold +"+(levelupNum*50)+" ãƒœãƒ¼ãƒŠã‚¹ï¼"),
        h('button',{style:{...S.btnGold,padding:"10px 32px"},onClick:()=>setLevelupShow(false)},"ç¶šã‘ã‚‹ï¼")
      )
    ),

    // Gacha modal
    h(GachaModal,null),

    h('div',{style:{maxWidth:820,margin:"0 auto",padding:"0 14px 80px"}},

      // Header
      h('div',{style:{textAlign:"center",padding:"22px 0 10px",position:"relative"}},
        h('div',{style:{fontFamily:"'Cinzel',serif",fontSize:"1.6rem",fontWeight:900,color:"#f0c040",letterSpacing:"0.05em"}},"âš” "+(prof.gameTitle||"CAPYBARA COMMAND CENTER")+" âš”"),
        h('div',{style:{color:"#8b7355",fontSize:"0.62rem",letterSpacing:"0.2em",textTransform:"uppercase",marginTop:3}},"ï½ž Quest Management System ï½ž"),
        h('button',{style:{position:"absolute",top:22,right:0,background:"rgba(0,0,0,0.3)",border:"1px solid rgba(240,192,64,0.2)",borderRadius:8,padding:"6px 10px",color:"#8b7355",fontSize:"0.75rem",cursor:"pointer"},onClick:openSettings},"âš™")
      ),

      // Character panel
      h('div',{style:{...S.panel,display:"grid",gridTemplateColumns:"110px 1fr",gap:16,alignItems:"center"}},
        // Avatar
        h('div',{style:{position:"relative"}},
          h('div',{style:{width:100,height:100,borderRadius:12,...frameStyle,overflow:"hidden",background:"rgba(0,0,0,0.3)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"3.5rem"}},
            prof.iconImage
              ? h('img',{src:prof.iconImage,style:{width:"100%",height:"100%",objectFit:"cover"}})
              : (prof.icon||"ðŸ¦«")
          ),
          h('div',{style:{position:"absolute",bottom:-7,right:-7,background:"linear-gradient(135deg,#f0c040,#b8860b)",color:"#000",fontFamily:"'Cinzel',serif",fontWeight:900,fontSize:"0.6rem",padding:"2px 7px",borderRadius:999}},"Lv."+lv),
          equippedFrame && h('div',{style:{position:"absolute",top:-7,left:-4,background:RC[equippedFrame.rarity].bg,border:"1px solid "+RC[equippedFrame.rarity].color,borderRadius:4,padding:"1px 5px",fontSize:"0.5rem",color:RC[equippedFrame.rarity].color,fontFamily:"'Cinzel',serif",whiteSpace:"nowrap"}},equippedFrame.name)
        ),
        // Stats
        h('div',null,
          h('div',{style:{fontFamily:"'Cinzel',serif",fontSize:"1.1rem",color:"#ffe88a",marginBottom:1}},prof.name||"ã‚«ãƒ”ãƒãƒ©å¸ä»¤å®˜"),
          equippedTitle
            ? h('div',{style:{fontSize:"0.68rem",fontFamily:"'Cinzel',serif",color:equippedTitle.color||"#a855f7",marginBottom:2,letterSpacing:"0.1em"}},
                "ã€Ž "+equippedTitle.name+" ã€")
            : h('div',{style:{color:"#a855f7",fontSize:"0.62rem",letterSpacing:"0.12em",marginBottom:2}},"â˜… "+(prof.className||"COMMANDER CLASS")+" â˜…"),
          h('div',{style:{color:"#8b7355",fontSize:"0.58rem",marginBottom:7}},
            "ATK "+(atk||0)+" / DEF "+(def||0)+" | ðŸ’° "+st.gold+"G"),
          [
            {label:"â¤ HP", val:st.hp, max:MAX_HP(lv), color:"linear-gradient(90deg,#dc2626,#f87171)"},
            {label:"ðŸ’™ MP", val:st.mp, max:MAX_MP(lv), color:"linear-gradient(90deg,#1d4ed8,#60a5fa)"},
            {label:"â­ EXP",val:st.xp, max:XP_NEEDED(lv),color:"linear-gradient(90deg,#854d0e,#ffe88a)"},
          ].map(row=>h('div',{key:row.label,style:{marginBottom:5}},
            h('div',{style:{display:"flex",justifyContent:"space-between",fontSize:"0.6rem",color:"#8b7355",marginBottom:2}},
              h('span',{style:{fontFamily:"'Cinzel',serif",fontWeight:700}},row.label),
              h('span',null,Math.max(0,row.val)+" / "+row.max)
            ),
            h(Bar,{value:row.val,max:row.max,color:row.color})
          )),
          h('div',{style:{display:"flex",gap:8,marginTop:6}},
            [{v:st.totalDefeated,l:"è¨Žä¼æ•°"},{v:st.totalXP,l:"ç·EXP"},{v:st.streak,l:"é€£ç¶šè¨Žä¼"}].map((s,i)=>
              h('div',{key:i,style:{background:"rgba(0,0,0,0.28)",border:"1px solid rgba(240,192,64,0.1)",borderRadius:7,padding:"4px 8px",textAlign:"center",flex:1}},
                h('div',{style:{fontFamily:"'Cinzel',serif",fontSize:"0.85rem",fontWeight:700,color:"#f0c040"}},s.v),
                h('div',{style:{fontSize:"0.55rem",color:"#8b7355",textTransform:"uppercase",letterSpacing:"0.08em"}},s.l)
              )
            )
          )
        )
      ),

      // Navigation
      h('div',{style:{display:"flex",gap:8,marginBottom:14}},
        [["quest","âš” ã‚¯ã‚¨ã‚¹ãƒˆ"],["shop","ðŸ›’ ã‚·ãƒ§ãƒƒãƒ—"],["inventory","ðŸŽ’ è£…å‚™"],["gacha","ðŸŽ° ã‚¬ãƒãƒ£"]].map(([k,l])=>
          h('button',{key:k,style:S.navBtn(page===k),onClick:()=>setPage(k)},l)
        )
      ),

      // Page
      page==="quest"     && renderQuest(),
      page==="shop"      && renderShop(),
      page==="inventory" && renderInventory(),
      page==="gacha"     && renderGacha(),
      page==="settings"  && renderSettings(),
    )
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(h(App));
</script>
</body>
</html>
